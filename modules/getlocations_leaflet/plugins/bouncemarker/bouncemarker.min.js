(function(){var originalOnAdd=L.Marker.prototype.onAdd;var originalOnRemove=L.Marker.prototype.onRemove;L.Marker.mergeOptions({bounceOnAdd:false,bounceOnAddOptions:{duration:1000,height:-1},bounceOnAddCallback:function(){}});L.Marker.include({_toPoint:function(latlng){return this._map.latLngToContainerPoint(latlng)},_toLatLng:function(point){return this._map.containerPointToLatLng(point)},_motionStep:function(timestamp,opts){var self=this;var timePassed=new Date()-opts.start;var progress=timePassed/opts.duration;if(progress>1){progress=1}var delta=self._easeOutBounce(progress);opts.step(delta);if(progress===1){opts.end();return}L.Util.requestAnimFrame(function(timestamp){self._motionStep(timestamp,opts)})},_bounceMotion:function(duration,callback){var original=L.latLng(this._origLatlng);var start_y=this._dropPoint.y;var start_x=this._dropPoint.x;var distance=this._point.y-start_y;var self=this;L.Util.requestAnimFrame(function(timestamp){self._motionStep(timestamp,{delay:10,duration:duration||1000,start:new Date(),step:function(delta){self._dropPoint.y=start_y+(distance*delta)-(self._map.project(self._map.getCenter()).y-self._origMapCenter.y);self._dropPoint.x=start_x-(self._map.project(self._map.getCenter()).x-self._origMapCenter.x);self.setLatLng(self._toLatLng(self._dropPoint))},end:function(){self.setLatLng(original);if(typeof callback==="function")callback()}})})},_easeOutBounce:function(pos){if((pos)<(1/2.75)){return(7.5625*pos*pos)}else if(pos<(2/2.75)){return(7.5625*(pos-=(1.5/ 2.75)) * pos + 0.75)} else if (pos < (2.5 /2.75)){return(7.5625*(pos-=(2.25/2.75))*pos+0.9375)}else{return(7.5625*(pos-=(2.625/2.75))*pos+0.984375)}},bounce:function(options,endCallback){this._origLatlng=this.getLatLng();this._bounce(options,endCallback)},_bounce:function(options,endCallback){if(typeof options==="function"){endCallback=options;options=null}options=options||{duration:1000,height:-1};if(typeof options==="number"){options.duration=arguments[0];options.height=arguments[1]}this._origMapCenter=this._map.project(this._map.getCenter());this._dropPoint=this._getDropPoint(options.height);this._bounceMotion(options.duration,endCallback)},_getDropPoint:function(height){this._point=this._toPoint(this._origLatlng);var top_y;if(height===undefined||height<0){top_y=this._toPoint(this._map.getBounds()._northEast).y}else{top_y=this._point.y-height}return new L.Point(this._point.x,top_y)},onAdd:function(map){this._map=map;this._origLatlng=this._latlng;if(this.options.bounceOnAdd===true){if(typeof this.options.bounceOnAddDuration!=="undefined"){this.options.bounceOnAddOptions.duration=this.options.bounceOnAddDuration}if(typeof this.options.bounceOnAddHeight!=="undefined"){this.options.bounceOnAddOptions.height=this.options.bounceOnAddHeight}this._dropPoint=this._getDropPoint(this.options.bounceOnAddOptions.height);this.setLatLng(this._toLatLng(this._dropPoint))}originalOnAdd.call(this,map);if(this.options.bounceOnAdd===true){this._bounce(this.options.bounceOnAddOptions,this.options.bounceOnAddCallback)}},onRemove:function(map){clearInterval(this._intervalId);originalOnRemove.call(this,map)}})})();